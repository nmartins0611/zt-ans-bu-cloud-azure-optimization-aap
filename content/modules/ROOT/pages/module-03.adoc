= Lab Guide: Building an Azure Optimization Workflow
:notoc:
:toc-title: Table of Contents
:sectnums:
:icons: font

_A guide to creating a workflow to filter instances and stop them using Ansible Automation Platform in a Microsoft Azure environment._

---

== Lab Briefing

This section provides an overview of the lab challenge and instructions for getting started.

=== Challenge Summary

In this challenge, you will create a **workflow**. Public cloud environments are often used by many different teams, and by using automation, you can create workflows to help enforce organizational policies.

image::../assets/images/full_workflow.png?raw=true[Example of a completed workflow, opts="border"]

=== Infrastructure Optimization

While a lot of cloud automation focuses on provisioning and de-provisioning, we can also use automation to help tame our public cloud environments and keep them under control. This is often called Day-2 operations or infrastructure optimization.

image::https://github.com/IPvSean/pictures_for_github/blob/master/optimize_circle.png?raw=true[The cycle of infrastructure optimization, opts="border"]

This can include tasks like identifying non-compliant resources, scheduling instances to be turned off outside of business hours, or finding and removing orphaned resources.

Two examples of infrastructure optimization are shown below

image::../assets/images/example_optimization.png?raw=true[Example of identifying a non-compliant VM instance, opts="border"]

image::../assets/images/example2_optimization.png?raw=true[Example of scheduling an instance to be stopped, opts="border"]

This concludes your lab briefing. Please move forward.

---

== Lab Guide: Hands-On Tasks

*Estimated time to complete: 20 minutes*

In this third challenge, you will create a link:https://docs.redhat.com/en/documentation/red_hat_ansible_automation_platform/latest/html/using_automation_execution/controller-workflow-job-templates[workflow] that uses your existing job template to find specific instances and then performs an action on them.

=== Task 1: Log into Ansible Automation Platform

First, you will log in to the Ansible Automation Platform to begin the lab exercises.

. **Navigate to the Ansible Automation Platform UI.**
+
Click on the **Ansible Automation Platform** tab at the top of your lab window.

. **Log in with the provided credentials.**
+
[cols="1,2a"]
|===
| Parameter | Value
| Username | `admin`
| Password | `ansible123!`
|===

After logging in, you will land on the main dashboard.

=== Task 2: Create the "Stop Instances" Job Template

You will start by creating a job template whose purpose is to stop Azure virtual machines.

. **Navigate to the Templates page.**
+
Expand the `Automation Execution` menu on the left.
`Automation Execution` -> `Templates`.

. **Create the new job template.**
+
Click the `+ Create Template` then scroll down and click `Create job template`
+

. **Enter the job template details.**
+
    Fill out the form with the following information:
+
[cols="1,1"]
|===
| Parameter               | Value
| Name                    | `Stop instances`
| Job Type                | `Run`
| Inventory               | `Azure Inventory`
| Project                 | `Azure Demos Project`
| Playbook                | `project/change_state_rhel_vm_demo.yml`
| Execution Environment   | `Microsoft Azure Execution Environment`
| Credentials             | `azure_credential`
|===
+
TIP: To select the `azure_credential`, click in the text field or on the drop down icon, then select `Microsoft Azure Resource Manager`.

. **Save the job template.**
+
Scroll to the bottom, click `Create job template`.

. **Understand the playbook execution.**
+
This playbook has one task:

It uses the `azure.azcollection.azure_rm_virtualmachine` module to change the state of VMs passed to it via the `vm_name_list` variable.

[source,yaml]
----
- name: toggle VM state
  azure.azcollection.azure_rm_virtualmachine:
    resource_group: "{{ resource_group_name }}"
    name: "{{ item }}"
    state: "{{ input_state | default('absent') }}"
  loop: "{{ vm_name_list }}"
----

=== Task 3: Build the Azure Optimization Workflow

Now, you will combine the template from the previous lab (`Retrieve instances by tag`) with the new `Stop instances` template into a single workflow template.

. **Navigate to the Templates page and initiate workflow creation.**
+
Expand the `Automation Execution` menu on the left.
`Automation Execution` -> `Templates`.
+
Click the `+ Create Template` then scroll down and click `Create WORKFLOW job template`
+
image::../assets/images/add_workflow.png?raw=true[Add workflow template button, 200, opts="border"]
+
. **Enter the workflow details.**
+
[cols="1,1"]
|===
| Parameter    | Value
| Name         | `Azure Workflow`
| Organization | `Default`
|===
+
**Click** `Create workflow job template`. The Workflow Visualizer will open.
+
. **Add the first node (Retrieve Instances).**
+
**Click** the blue `+ Add Step` button. Configure the first step as follows:
+
--
a.  **Node Type:** `Job Template`
b.  **Job Template:** Select `Retrieve instances by tag`. Click `Next`.
c.  **Survey:** In the `Provide a specific tag` field, enter/select `os:windows`.
d.  Click `Next`, then `Finish` to add the node.
--

. **Add the second node (Stop Instances).**
+
**Hover** over the elipsis (3 dots) of the `Retrieve instances by tag` node, **click** the `+ Add Step and link` option.
+
Configure it as follows:
+
--
a.  **Job Template:** Select `Stop instances`.
b.  **Status:** Select `Run On Success`. Click `Next`.
c.  Click `Finish`.
--
. **Save the workflow.**
+
In the top left corner of the Visualizer, **click** `Save`.
+
image::../assets/images/save_workflow.png?raw=true[Save workflow button, 300, opts="border"]

=== Task 4: Launch the Workflow

Now you are ready to run the complete workflow.

. **Navigate to the Templates page.**
+
Expand the `Automation Execution` menu on the left.
`Automation Execution` -> `Templates`.

. **Launch the workflow.**
+
Find the `Azure Workflow` in the list and click `ðŸš€ Launch template` icon.
+
image:https://github.com/IPvSean/pictures_for_github/blob/master/launch_job.png?raw=true[Launch Job Icon, 80, opts="border"]

. **Monitor the visualizer.**
+
The workflow visualizer will show the real-time progress. The workflow will:
+
.   Run the `Retrieve instances by tag` node to identify the `WIN-ansible` instance.
.   Upon success, run the `Stop instances` node, which will turn off the instance identified in the first step.

=== Task 5: Verify the Instance is Stopped

Finally, you will confirm the result using one of the following methods.

==== Option 1: By Updating the Azure Inventory Source

. **Navigate to the inventory source.**
+
In the left navigation menu, Expand `Automation Execution` -> `Infrastructure` -> `Inventories`.Select `Azure Inventory`, then select the **Sources** tab.

. **Sync the inventory.**
+
**Click** on `Rocket Launcher Rocket ðŸš€ icon` and wait for the status to show **Successful**.

. **Check the hosts.**
+
Switch to the `Hosts` tab. You should now see that the `WIN-ansible` host is no longer in the inventory (as it is no longer running).

==== Option 2: By Validating in the Cloud Azure tab

. **Navigate to the Cloud (Azure) tab.**
+
**Click** on the `Cloud (Azure)` tab to open it and view the Azure resources.
+
. **Check the instance status.**
+
You should see that the `RHEL-ansible` instance is still running, while the Windows instance has been successfully stopped and deallocated.
+
image::../assets/images/virtual_machine_example.png?raw=true[Instance status in Azure portal, opts="border"]

---

== Why Cloud Optimization is Important

You have successfully completed this challenge. This simple lab demonstrates a powerful concept for managing cloud costs and resources. Automation workflows can help you:

* **Turn off unused resources:** Automatically shut down instances that are no longer needed.
* **Right-size cloud resources:** Identify over-provisioned instances and adjust them.
* **Recover orphaned resources:** Find and remove resources left behind by failed processes.

Imagine scheduling a workflow to run nightly, searching for any development instances left running for more than a few hours. This gives cloud teams peace of mind that their infrastructure is not incurring unnecessary charges.

Thank you for taking the time to learn about automating cloud infrastructure optimization tasks in Azure using the Red Hat Ansible Automation Platform!

NOTE: The Ansible Playbooks for this lab are sourced from this link:https://github.com/ansible-cloud/azure-demos[project on GitHub]. 

