= Lab Guide: Understanding Tags for Azure Optimization
:notoc:
:toc-title: Table of Contents
:sectnums:
:icons: font

_A guide to understanding basic cloud optimization exercises, starting with dynamic inventory and resource tagging in Microsoft Azure._

---

== Lab Briefing

This section provides an overview of the lab environment and the importance of resource tagging in the cloud.

=== Lab Summary

Welcome to the Ansible Hybrid Cloud Automation - Cloud Optimization lab. In this lab, you will use Microsoft Azure as the public cloud provider. We have created an Azure account just for this lab so you can automate against a real Microsoft Azure environment with two virtual machines already running.

image:https://github.com/IPvSean/pictures_for_github/blob/master/optimization.png?raw=true[Diagram of cloud optimization, opts="border"]

=== Cloud Resources

Cloud environments are composed of numerous resources, including instances, containers, networks, and more. To effectively manage these resources, it is crucial to use **tags**. Tags are simple key-value pairs that help you organize, filter, and track your assets. There is no limit to how many tags a resource can have.

image::../assets/cloud_resources.png[Various Azure cloud resources, opts="border"]

=== Example of Tags

This screenshot from the Microsoft Azure console shows a virtual machine with several tags. These tags help to quickly understand what the instance is used for, who provisioned it, who owns it, and more.

image::../assets/screenshot_tags.png[Example of tags on an Azure virtual machine, opts="border"]

This concludes your lab briefing. Please click the green **Start** button if the lab has not already begun.

image:https://github.com/IPvSean/pictures_for_github/blob/master/start_button.png?raw=true[Start Button, 100, opts="border"]

---

== Lab Guide: Hands-On Tasks

*Estimated time to complete: 10 minutes*

In this first challenge, you will learn about the pre-configured Dynamic Inventory for this lab and see how it uses tags to identify resources.

=== Task 1: Log into Automation Controller

First, you will log in to the automation controller to begin the lab exercises.

. **Navigate to the Automation Controller UI.**
+
Click on the **Automation Controller** tab at the top of your lab window.

. **Log in with the provided credentials.**
+
[cols="1,2a"]
|===
| Username | `admin`
| Password | `ansible123!`
|===

After logging in, you will land on the main dashboard.

=== Task 2: Examine the Dynamic Inventory

Next, you will explore the pre-configured dynamic inventory and inspect the host variables and tags that were automatically discovered from Azure.

. **Navigate to the Inventories page.**
+
In the left navigation menu, go to **Resources** â†’ **Inventories**.
+
image:https://github.com/IPvSean/pictures_for_github/blob/master/inventories.png?raw=true[Inventories link in navigation menu, 200, opts="border"]

. **Select the Azure Inventory.**
+
The inventory has been created for you and synced from Azure automatically. **Click** on the inventory named `Azure Inventory`.
+
image::../assets/azure_inventory.png[Azure Inventory details page, opts="border"]

. **View the hosts.**
+
**Click** on the **Hosts** tab. You will see two hosts listed.
+
image:https://github.com/IPvSean/pictures_for_github/blob/master/inventory_hosts_tab.png?raw=true[Inventory Hosts tab, 300, opts="border"]

. **Inspect a host's variables.**
+
**Click** on one of the hosts to open its details page.
+
image::../assets/hosts_returned.png[List of returned hosts, opts="border"]

. **Examine the tags.**
+
On the host's *Details* tab, find the `VARIABLES` section and **click** the **Expand** icon on the right-hand side.
+
image:https://github.com/IPvSean/pictures_for_github/blob/master/expand.png?raw=true[Expand variables icon, 100, opts="border"]
+
Scroll down to the `tags` section to see the key-value pairs discovered from the Azure virtual machine. Take note of the tags, as you will use them in a future challenge.
+
image::../assets/azure_tags.png[Azure tags in the host variables, opts="border"]
+
**Click** the **Done** button when you are finished.

TIP: To see these same tags in the Azure console, you can open the **Azure Portal** tab in your lab environment and log in with the provided credentials.

=== Task 3: Create a Job Template to Display Tags

Now, you will create a job template to run a playbook that retrieves and displays tag information.

. **Navigate to the Templates page.**
+
In the left navigation menu, go to **Resources** â†’ **Templates**.
+
image:https://github.com/IPvSean/pictures_for_github/blob/master/job_templates.png?raw=true[Templates link in navigation menu, 200, opts="border"]

. **Create a new job template.**
+
**Click** the blue **Add** button and select **Add job template**.
+
image:https://github.com/IPvSean/pictures_for_github/blob/master/add_job_template.png?raw=true[Add job template button, 200, opts="border"]

. **Enter the job template details.**
+
Fill out the form with the following information:
+
[cols="1,1"]
|===
| Parameter | Value
| Name | `Display tag information`
| Job Type | `Run`
| Inventory | `Demo Inventory`
| Project | `Cloud Visibility Project`
| Execution Environment | `Microsoft Azure Execution Environment`
| Playbook | `playbooks/display_tags.yml`
| Credentials | `azure_credential`
|===
+
NOTE: To find the `azure_credential`, you may need to filter the *Credential Type* to `Microsoft Azure Resource Manager`.

. **Save the job template.**
+
**Click** the blue **Save** button.

NOTE: The Ansible Playbooks for this lab are sourced from this link:https://github.com/ansible-cloud/azure_visibility[project on GitHub].

=== Task 4: Launch the Job and Review Output

Finally, you will run the job template and examine the structured data it collects.

. **Launch the job template.**
+
Navigate back to the **Templates** page, find the `Display tag information` job template, and **click** the **Launch** icon (ðŸš€).
+
image:https://github.com/IPvSean/pictures_for_github/blob/master/launch_job.png?raw=true[Launch Job Icon, 80, opts="border"]

. **Understand the playbook execution.**
+
This playbook runs three tasks:
+
* It uses the `azure.azcollection.azure_rm_virtualmachine_info` module to retrieve information for all virtual machines.
* The second task prints the entire JSON payload from the first task.
* The third task prints a formatted summary of the name, tags, and power state for each VM.
+
[source,yaml]
----
- name: print tags
  ansible.builtin.debug:
    msg:
      - name: "{{ item.name }}"
      - tags: "{{ item.tags }}"
      - power_state: "{{ item.power_state }}"
  loop: "{{ retrieved_info.vms | list }}"
  loop_control:
      label: "virtual machine info and associated tags"
----

. **Review the job output.**
+
The output in the automation controller will show this structured data clearly for each resource.
+
image::../assets/output_tags.png[Job output showing formatted tag data, opts="border"]

---

== Next Steps

Press the `Check` button below to proceed to the next challenge.

== Troubleshooting

If you have encountered an issue or have noticed something not quite right, please link:https://github.com/ansible/instruqt/issues/new?title=Issue+with+Ansible+Hybrid+Cloud+Automation+-+Infrastructure+visibility&assigneething
